<!-- PATH: /index.html :: FULL REPLACE -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NAVI TOUR – Landing</title>
  <meta name="description" content="역사와 독립운동의 길을 따라가는 프리미엄 테마 여행, NAVI TOUR 랜딩 페이지"/>

  <!-- 히어로 칩(배너) + 시트 로더 + 메인 카드 렌더러 -->
  <script src="Js/HeroChips.js" defer></script>
  <script src="Js/ProductSheetLoader.js" defer></script>
  <script src="Main/Main_Cards.js" defer></script>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;800&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
  <!-- ===== HEADER (외부 파일 주입) ===== -->
  <div id="site-header" data-src="Comp/Header.html"></div>

  <!-- ===== BANNER (히어로 + 필터 외부 파일 주입) ===== -->
  <div id="site-banner" data-src="Main/Main_Banner.html"></div>

  <!-- ===== MAIN (외부 파일 주입) ===== -->
  <div id="site-main" data-src="Main/Main.html"></div>

  <!-- ===== 본문 하단 문의 CTA (Comp/Receipt.html 주입) ===== -->
  <div id="site-receipt" data-src="Comp/Receipt.html"></div>

  <!-- ===== FOOTER (외부 파일 주입 – Comp/Footer.html) ===== -->
  <div id="site-footer" data-src="Comp/Footer.html"></div>

  <!-- ===== 레이아웃 조각 주입 + 칩 초기화 + ABOUT 내부 슬롯 로더 ===== -->
  <script>
    (function(){
      'use strict';

      /**
       * 공용 조각 로더
       * @param {string} id         - placeholder element id
       * @param {string} defaultSrc - data-src 없을 때 fallback 경로
       * @param {Function} [onLoaded] - outerHTML 교체 후 콜백
       */
      function loadFragment(id, defaultSrc, onLoaded){
        const host = document.getElementById(id);
        if (!host) return;

        const src = host.getAttribute('data-src') || defaultSrc;

        fetch(src, { cache:'no-store' })
          .then(r => r.text())
          .then(html => {
            host.outerHTML = html;
            if (typeof onLoaded === 'function') onLoaded();
          })
          .catch(err => {
            console.error('[NAVI TOUR] fragment load failed:', id, '→', src, err);
          });
      }

      // 칩 초기화 (배너 삽입 후 한 번만 실행)
      function initChips(){
        const chips = document.querySelectorAll('.chiprail .chip');
        if (!chips.length) return;

        const MAP = {
          '전체':'all',
          '서간도의 길':'sgando',
          '북간도의 길':'bgando',
          '임시정부의 발자취':'gov',
          '극동 연해주의 길':'fareast',
          '일본내 독립운동':'jpn',
          '하와이 독립운동':'hawaii'
        };

        chips.forEach(chip => {
          const key = MAP[chip.textContent.trim()] || 'all';
          chip.dataset.cat = key;

          chip.addEventListener('click', () => {
            chips.forEach(c => c.classList.remove('is-active'));
            chip.classList.add('is-active');
            if (window.setCategory) window.setCategory(key);
          });
        });

        // URL ?cat= 동기화
        const cur = new URLSearchParams(window.location.search).get('cat');
        if (cur) {
          const target = Array.from(chips).find(c => c.dataset.cat === cur);
          if (target) {
            chips.forEach(c => c.classList.remove('is-active'));
            target.classList.add('is-active');
          }
        }
      }

      /* ===== ABOUT 내부 슬롯 로더 (리뷰 / 문의섹션) ===== */

      // 슬롯 ID → 가져올 HTML 경로
      const SLOT_MAP = {
        'nt-review-slot':  'Main/Main_Review.html',
        'nt-receipt-slot': 'Main/Main_Receipt.html'
      };

      // 실제 로딩 함수: slot.innerHTML 채우고, 안의 script 다시 실행
      function loadSlotInto(slot, url){
        if (!slot || slot.dataset.loaded === '1') return;
        slot.dataset.loaded = '1';

        fetch(url, { cache:'no-store' })
          .then(r => r.text())
          .then(html => {
            slot.innerHTML = html;

            // 삽입된 HTML 안의 <script> 실행
            const scripts = slot.querySelectorAll('script');
            scripts.forEach(oldScript => {
              const s = document.createElement('script');
              if (oldScript.src) {
                s.src = oldScript.src;
              } else {
                s.textContent = oldScript.textContent;
              }
              document.body.appendChild(s);
            });
          })
          .catch(err => {
            console.error('[NAVI TOUR] slot load failed:', url, err);
          });
      }

      // 현재 DOM에서 슬롯들을 찾아 로딩
      function checkSlots(){
        Object.keys(SLOT_MAP).forEach(id => {
          const slot = document.getElementById(id);
          if (slot && slot.dataset.loaded !== '1') {
            loadSlotInto(slot, SLOT_MAP[id]);
          }
        });
      }

      let slotObserverStarted = false;
      function startSlotObserver(){
        if (slotObserverStarted) return;
        slotObserverStarted = true;

        // 처음 한 번 바로 체크
        checkSlots();

        // 이후로는 body 변화 감시해서,
        // Main_about가 다시 그려질 때마다 새 슬롯을 찾아서 로드
        const obs = new MutationObserver(checkSlots);
        obs.observe(document.body, { childList:true, subtree:true });
      }

      // 조각 주입 시작
      loadFragment('site-header', 'Comp/Header.html');
      loadFragment('site-banner', 'Main/Main_Banner.html', initChips);
      loadFragment('site-main', 'Main/Main.html', function(){
        // 메인 조각 주입 완료 신호
        window.dispatchEvent(new Event('navitour:main-loaded'));
        // "전체" 카테고리에서 Main_about.html이 꽂힐 때를 대비해 슬롯 감시 시작
        startSlotObserver();
      });

      // 본문 하단 문의 CTA 조각
      loadFragment('site-receipt', 'Comp/Receipt.html');

      // 푸터 조각
      loadFragment('site-footer', 'Comp/Footer.html');
    })();
  </script>
</body>
</html>
